<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musiker</title>
    <style>
        :root {
            --frame-color: #2c2c2c;
            --screen-bg: #0f0f0f;
            --accent-red: #d32f2f;
            --accent-red-glow: #ff5252;
        }
        body { background-color: #e0e0e0; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: 'SF Mono', 'Courier New', Courier, monospace; user-select: none; }

        /* --- 1. 手机外框 --- */
        .iphone-frame {
            position: relative; width: 860px; height: 390px; background: #000; border-radius: 60px;
            box-shadow: 0 0 0 2px #333, 0 0 0 6px #4a4a4a, 0 0 0 7px #000, 20px 30px 60px rgba(0,0,0,0.6);
            padding: 18px; box-sizing: border-box; z-index: 1;
        }

        /* --- 2. 物理按键 --- */
        .btn-physical { position: absolute; background: #2a2a2a; border-radius: 4px 4px 0 0; box-shadow: inset -1px -1px 2px rgba(0,0,0,0.5), inset 1px 1px 1px rgba(255,255,255,0.2); z-index: 0; }
        .btn-vol-up { width: 50px; height: 4px; top: -4px; left: 200px; }
        .btn-vol-down { width: 50px; height: 4px; top: -4px; left: 260px; }
        .btn-power { width: 80px; height: 4px; bottom: -4px; left: 220px; transform: rotate(180deg); }

        /* --- 3. 屏幕 --- */
        .screen {
            width: 100%; height: 100%; background: var(--screen-bg); border-radius: 44px; overflow: hidden;
            position: relative; display: flex; flex-direction: column; gap: 15px;
            padding: 10px 40px 10px 65px; box-sizing: border-box;
        }

        /* --- 4. 灵动岛 --- */
        .dynamic-island {
            position: absolute; left: 18px; top: 50%; transform: translateY(-50%);
            width: 28px; height: 115px; background: #000; border-radius: 14px;
            z-index: 100; display: flex; flex-direction: column; align-items: center;
            justify-content: flex-start; padding-top: 25px; gap: 12px;
        }
        .camera-lens {
            width: 14px; height: 14px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #2a3a55 0%, #0d121c 50%, #000 100%);
            box-shadow: inset 0 0 2px rgba(255,255,255,0.2); position: relative; margin-bottom: 2px;
        }
        .camera-lens::after { content: ''; position: absolute; top: 3px; left: 3px; width: 4px; height: 4px; background: rgba(255,255,255,0.4); border-radius: 50%; filter: blur(1px); }
        .sensor { width: 10px; height: 10px; background: #111; border-radius: 50%; opacity: 0.8; }

        /* --- 5. 听筒 --- */
        .speaker-grill { position: absolute; left: 7px; top: 50%; transform: translateY(-50%); width: 3px; height: 40px; background: #1a1a1a; border-radius: 2px; box-shadow: inset 1px 1px 2px #000; }

        /* --- 顶部波形区 --- */
        .top-section {
            height: 70px; background: #080808; border-radius: 20px; border: 1px solid #333;
            position: relative; display: flex; align-items: center; padding: 0 15px;
            box-shadow: inset 2px 2px 10px rgba(0,0,0,0.6); overflow: hidden; flex-shrink: 0;
        }
        .waveform-canvas { width: 100%; height: 50px; cursor: pointer; }
        .cursor-line {
            position: absolute; top: 8px; bottom: 8px; width: 2px;
            background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red);
            z-index: 10; pointer-events: none; left: 15px; transition: left 0.05s linear;
        }
        .wf-controls {
            position: absolute; top: 3px; right: 10px;
            display: flex; gap: 3px; z-index: 11;
        }
        .wf-controls button {
            background: rgba(255,255,255,0.05); border: 1px solid #333;
            color: #555; font-size: 8px; padding: 1px 5px; border-radius: 3px;
            cursor: pointer; font-family: inherit;
        }
        .wf-controls button:hover { color: #ccc; background: rgba(255,255,255,0.12); }
        .time-scale {
            position: absolute; bottom: 1px; left: 15px; right: 15px;
            display: flex; justify-content: space-between;
            font-size: 7px; color: #383838; pointer-events: none;
        }

        /* --- 主控区域 --- */
        .main-controls { display: flex; gap: 20px; flex: 1; min-height: 0; }

        /* --- 左侧 --- */
        .left-panel { flex: 1.2; display: flex; flex-direction: column; gap: 10px; }
        .lcd-screen {
            background: radial-gradient(circle at center, #1a222c, #000); border-radius: 16px;
            padding: 10px 12px; border: 1px solid #333;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.8), 0 0 5px rgba(255,255,255,0.05);
            color: #fff; position: relative; flex: 1; display: flex; flex-direction: column; justify-content: center;
        }
        .lcd-header { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-bottom: 4px; }
        .play-indicator { display: flex; align-items: center; gap: 5px; color: #555; font-weight: bold; transition: color 0.3s; }
        .play-indicator.active { color: #4caf50; }
        .play-dot { width: 6px; height: 6px; background: #333; border-radius: 50%; transition: all 0.3s; }
        .play-dot.active { background: #4caf50; box-shadow: 0 0 6px #4caf50; }
        .filename { font-size: 10px; color: #999; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .timer { font-size: 30px; font-weight: 700; text-shadow: 0 0 10px rgba(255,255,255,0.3); letter-spacing: 2px; }
        .duration-line { font-size: 9px; text-align: right; color: #555; margin-top: 2px; }

        /* --- 播放控制栏 --- */
        .playback-controls {
            display: flex; align-items: center; justify-content: center;
            gap: 12px; margin-top: 8px; padding: 6px 0;
            border-top: 1px solid #222;
        }
        .ctrl-btn {
            background: rgba(255,255,255,0.05); border: 1px solid #333;
            color: #888; font-size: 14px; width: 32px; height: 24px;
            border-radius: 6px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            transition: all 0.15s;
        }
        .ctrl-btn:hover { color: #fff; background: rgba(255,255,255,0.12); }
        .ctrl-btn:active { transform: scale(0.95); }
        .ctrl-btn.play-pause { width: 40px; font-size: 16px; }
        .loop-btn { width: 32px; position: relative; }
        .loop-btn.single { border-color: var(--accent-red); }
        .loop-btn.single .loop-icon { stroke: var(--accent-red-glow); }
        .loop-btn.shuffle { border-color: #4caf50; }
        .loop-btn.shuffle .loop-icon { stroke: #4caf50; }
        .loop-icon { width: 14px; height: 14px; stroke: #888; stroke-width: 1.5; fill: none; }
        .volume-row { display: flex; align-items: center; gap: 5px; }
        .vol-btn {
            background: rgba(255,255,255,0.05); border: 1px solid #333;
            color: #666; font-size: 10px; padding: 1px 7px; border-radius: 4px;
            cursor: pointer; font-family: inherit;
        }
        .vol-btn:hover { color: #fff; background: rgba(255,255,255,0.12); }
        .vol-label { font-size: 9px; color: #555; min-width: 28px; text-align: center; }

        /* --- 胶囊按钮 --- */
        .pill-buttons { display: flex; gap: 8px; }
        .pill-btn {
            background: linear-gradient(145deg, #2b2b2b, #1a1a1a); border: none; color: #aaa;
            padding: 10px 10px; border-radius: 20px; font-size: 9px; font-weight: bold;
            flex: 1; text-align: center;
            box-shadow: 3px 3px 6px #0b0b0b, -1px -1px 3px #383838;
            cursor: pointer; font-family: inherit; transition: all 0.1s;
        }
        .pill-btn:active { box-shadow: inset 2px 2px 5px #0b0b0b, inset -2px -2px 5px #383838; color: #fff; }
        .pill-btn.active { color: var(--accent-red-glow); box-shadow: inset 2px 2px 5px #0b0b0b, inset -2px -2px 5px #383838; }

        /* --- 中间：电平表 --- */
        .center-panel {
            width: 70px; background: #151515; border-radius: 20px;
            box-shadow: inset 2px 2px 8px #000;
            display: flex; justify-content: center; align-items: center; padding: 8px; gap: 6px;
        }
        .meter-track {
            width: 18px; height: 85%; background: #0a0a0a; border-radius: 4px;
            position: relative; overflow: hidden; border: 1px solid #222;
        }
        .meter-fill {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, #2ecc71, #f1c40f 60%, #e74c3c 85%);
            border-radius: 0 0 3px 3px; transition: height 0.05s;
        }
        .meter-label { font-size: 8px; color: #444; writing-mode: vertical-lr; transform: rotate(180deg); }
        .db-marks { display: flex; flex-direction: column; justify-content: space-between; height: 85%; font-size: 7px; color: #3a3a3a; }

        /* --- 右侧 --- */
        .right-panel { flex: 1.5; position: relative; display: flex; align-items: center; justify-content: space-around; }
        .circle-controls { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .circle-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: linear-gradient(145deg, #2a2a2a, #181818); border: 1px solid #111;
            box-shadow: 4px 4px 8px #0a0a0a, -2px -2px 6px #333;
            display: flex; justify-content: center; align-items: center;
            color: #eee; position: relative; cursor: pointer;
        }
        .circle-btn:active { box-shadow: inset 3px 3px 6px #000, inset -2px -2px 4px #333; }
        .circle-btn.red { background: radial-gradient(circle, #800 30%, #400 100%); box-shadow: inset 0 0 10px #000, 0 0 5px rgba(200,0,0,0.2); }
        .stop-square { width: 12px; height: 12px; background: #ddd; border-radius: 2px; }
        .btn-label { position: absolute; bottom: -18px; font-size: 8px; color: #555; font-weight: bold; white-space: nowrap; }

        /* --- Jog Wheel --- */
        .jog-wheel {
            width: 160px; height: 160px; border-radius: 50%;
            background: conic-gradient(from 0deg, #111 0%, #222 10%, #111 20%, #222 30%, #000 40%, #222 50%, #111 60%, #222 70%, #111 80%, #222 90%, #111 100%);
            box-shadow: inset 0 0 30px #000, 8px 8px 20px #050505, -3px -3px 10px #333;
            display: flex; justify-content: center; align-items: center;
            position: relative; cursor: pointer;
        }
        .jog-wheel.spinning { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .jog-cross { position: absolute; width: 100%; height: 1px; background: rgba(255,255,255,0.08); }
        .jog-inner {
            width: 70px; height: 70px; border-radius: 50%;
            background: radial-gradient(circle, #222, #000);
            box-shadow: inset 2px 2px 5px rgba(255,255,255,0.1), 0 0 10px #000;
            display: flex; justify-content: center; align-items: center; z-index: 1;
        }
        .play-icon { width: 0; height: 0; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-left: 14px solid #ddd; filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
        .pause-icon { display: flex; gap: 3px; }
        .pause-icon div { width: 4px; height: 16px; background: #ddd; border-radius: 1px; filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
        .decoration-text { position: absolute; color: #444; font-size: 8px; transform: rotate(-45deg); bottom: 25px; left: 25px; }

        /* --- Popups --- */
        .popup {
            display: none; position: absolute; bottom: 70px; left: 65px;
            background: radial-gradient(circle at center, #1a222c, #0a0a0a);
            border: 1px solid #333; border-radius: 14px;
            padding: 14px 18px; min-width: 260px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.6); z-index: 20; color: #ccc;
        }
        .popup.show { display: block; }
        .popup h3 { font-size: 10px; color: #555; margin-bottom: 8px; letter-spacing: 2px; }
        .popup-row { font-size: 10px; color: #666; padding: 3px 0; display: flex; justify-content: space-between; }
        .popup-row span:last-child { color: #bbb; }
        .eq-presets { display: flex; gap: 8px; flex-wrap: wrap; }
        .eq-btn {
            background: linear-gradient(145deg, #2b2b2b, #1a1a1a);
            border: 1px solid #333; color: #888; padding: 8px 14px; border-radius: 12px;
            font-size: 10px; cursor: pointer; font-family: inherit;
            box-shadow: 3px 3px 6px #0b0b0b, -1px -1px 3px #383838;
        }
        .eq-btn:hover { color: #ccc; }
        .eq-btn.active { color: var(--accent-red-glow); box-shadow: inset 2px 2px 4px #0b0b0b, inset -1px -1px 3px #383838; border-color: var(--accent-red); }

        /* --- Drop overlay --- */
        .drop-overlay {
            display: none; position: absolute; inset: 0;
            background: rgba(15, 15, 15, 0.93); border: 3px dashed var(--accent-red);
            border-radius: 44px; z-index: 30;
            flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        }
        .drop-overlay.show { display: flex; }
        .drop-overlay .drop-text { font-size: 14px; color: var(--accent-red); }
        .drop-overlay .drop-sub { font-size: 10px; color: #555; }

        /* --- Empty state --- */
        .empty-state {
            position: absolute; inset: 0; z-index: 5;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 8px; color: #444; pointer-events: none;
        }
        .empty-state.hidden { display: none; }
        .empty-state .es-text { font-size: 13px; }
        .empty-state .es-sub { font-size: 10px; color: #333; }
        .empty-state .browse-btn {
            margin-top: 6px; pointer-events: auto;
            background: linear-gradient(145deg, #2b2b2b, #1a1a1a);
            border: 1px solid #444; color: #888; padding: 8px 20px; border-radius: 16px;
            font-size: 10px; cursor: pointer; font-family: inherit;
            box-shadow: 3px 3px 6px #0b0b0b, -1px -1px 3px #383838;
        }
        .empty-state .browse-btn:hover { color: #fff; }
    </style>
</head>
<body>
    <div class="btn-physical btn-vol-up"></div>
    <div class="btn-physical btn-vol-down"></div>
    <div class="btn-physical btn-power"></div>

    <div class="iphone-frame">
        <div class="speaker-grill"></div>
        <div class="screen" id="screen">
            <div class="dynamic-island">
                <div class="camera-lens"></div>
                <div class="sensor"></div>
            </div>

            <!-- Empty state -->
            <div class="empty-state" id="emptyState">
                <div style="font-size:32px; opacity:0.4;">&#9835;</div>
                <div class="es-text">Drag audio file here</div>
                <div class="es-sub">MP3 / WAV / FLAC / OGG / AAC</div>
                <button class="browse-btn" id="browseBtn">Browse File</button>
            </div>

            <!-- Drop overlay -->
            <div class="drop-overlay" id="dropOverlay">
                <div style="font-size:36px; opacity:0.5;">&#9835;</div>
                <div class="drop-text">Drop audio file to play</div>
                <div class="drop-sub">MP3 / WAV / FLAC / OGG / AAC</div>
            </div>

            <!-- 顶部波形区 -->
            <div class="top-section">
                <div class="wf-controls">
                    <button id="rwBtn">&#9664;&#9664; 10s</button>
                    <button id="ffBtn">10s &#9654;&#9654;</button>
                </div>
                <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
                <div class="cursor-line" id="cursorLine"></div>
                <div class="time-scale" id="timeScale"></div>
            </div>

            <!-- 主控区域 -->
            <div class="main-controls">
                <!-- 左侧 LCD -->
                <div class="left-panel">
                    <div class="lcd-screen">
                        <div class="lcd-header">
                            <div class="play-indicator" id="playIndicator">
                                <div class="play-dot" id="playDot"></div>
                                <span id="statusText">STOP</span>
                            </div>
                            <div class="volume-row">
                                <button class="vol-btn" id="volDown">&minus;</button>
                                <span class="vol-label" id="volLabel">80%</span>
                                <button class="vol-btn" id="volUp">+</button>
                            </div>
                        </div>
                        <div class="filename" id="fileName">&mdash;</div>
                        <div class="timer" id="timer">0.00.00</div>
                        <div class="duration-line">/ <span id="durationText">0.00.00</span></div>
                        <div class="playback-controls">
                            <button class="ctrl-btn" id="prevBtn" title="上一曲">&#9198;</button>
                            <button class="ctrl-btn play-pause" id="playPauseBtn" title="播放/暂停">&#9654;</button>
                            <button class="ctrl-btn" id="nextBtn" title="下一曲">&#9197;</button>
                            <button class="ctrl-btn loop-btn" id="loopBtn" title="循环模式"><svg class="loop-icon" viewBox="0 0 16 16"><path d="M2 5h10l-2-2M14 5v4a2 2 0 01-2 2H4l2 2M4 11H2"/></svg></button>
                        </div>
                    </div>
                    <div class="pill-buttons">
                        <button class="pill-btn" id="btnBack">BACK<br><span style="font-size:8px; opacity:0.6">HOME</span></button>
                        <button class="pill-btn" id="btnSystem">SYSTEM</button>
                        <button class="pill-btn" id="btnEffect">EFFECT</button>
                    </div>
                </div>

                <!-- 中间：电平表 -->
                <div class="center-panel">
                    <span class="meter-label">L</span>
                    <div class="meter-track"><div class="meter-fill" id="meterL" style="height:0%"></div></div>
                    <div class="meter-track"><div class="meter-fill" id="meterR" style="height:0%"></div></div>
                    <span class="meter-label">R</span>
                    <div class="db-marks"><span>0</span><span>-12</span><span>-24</span><span>-48</span></div>
                </div>

                <!-- 右侧 -->
                <div class="right-panel">
                    <div class="circle-controls">
                        <div class="circle-btn" id="stopBtn">
                            <div class="stop-square"></div>
                            <span class="btn-label">STOP</span>
                        </div>
                        <div class="circle-btn red" style="opacity:0.4; cursor:default;">
                            <span class="btn-label">REC</span>
                        </div>
                    </div>
                    <div class="jog-wheel" id="jogWheel">
                        <div class="jog-cross" style="transform:rotate(45deg);"></div>
                        <div class="jog-cross" style="transform:rotate(-45deg);"></div>
                        <div class="jog-inner" id="jogInner">
                            <div id="jogIcon"><div class="play-icon"></div></div>
                        </div>
                        <div class="decoration-text" id="trackInfo">44.1k/16</div>
                    </div>
                </div>
            </div>

            <!-- SYSTEM popup -->
            <div class="popup" id="systemPopup">
                <h3>SYSTEM INFO</h3>
                <div class="popup-row"><span>File</span><span id="sysFile">&mdash;</span></div>
                <div class="popup-row"><span>Type</span><span id="sysType">&mdash;</span></div>
                <div class="popup-row"><span>Size</span><span id="sysSize">&mdash;</span></div>
                <div class="popup-row"><span>Sample Rate</span><span id="sysSR">&mdash;</span></div>
                <div class="popup-row"><span>Channels</span><span id="sysCh">&mdash;</span></div>
                <div class="popup-row"><span>Duration</span><span id="sysDur">&mdash;</span></div>
            </div>

            <!-- EFFECT popup -->
            <div class="popup" id="effectPopup">
                <h3>EQ PRESET</h3>
                <div class="eq-presets">
                    <button class="eq-btn active" data-eq="normal">Normal</button>
                    <button class="eq-btn" data-eq="bass">Bass Boost</button>
                    <button class="eq-btn" data-eq="vocal">Vocal</button>
                    <button class="eq-btn" data-eq="rock">Rock</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="audio/*" style="display:none">

<script>
// ─── State ───
let audioCtx, sourceNode, gainNode, analyserL, analyserR, biquadFilter, splitter, merger;
let audioBuffer = null, isPlaying = false, startTime = 0, pauseOffset = 0, volume = 0.8;
let waveformData = [], currentFile = null, animFrame = null;
let loopMode = 'list'; // 'list' | 'single' | 'shuffle'
const $ = id => document.getElementById(id);

// ─── Audio Engine ───
function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    gainNode = audioCtx.createGain();
    gainNode.gain.value = volume;
    biquadFilter = audioCtx.createBiquadFilter();
    biquadFilter.type = 'peaking'; biquadFilter.frequency.value = 1000; biquadFilter.gain.value = 0;
    analyserL = audioCtx.createAnalyser(); analyserL.fftSize = 256;
    analyserR = audioCtx.createAnalyser(); analyserR.fftSize = 256;
    splitter = audioCtx.createChannelSplitter(2);
    merger = audioCtx.createChannelMerger(2);
    biquadFilter.connect(splitter);
    splitter.connect(analyserL, 0); splitter.connect(analyserR, 1);
    splitter.connect(merger, 0, 0); splitter.connect(merger, 1, 1);
    merger.connect(gainNode); gainNode.connect(audioCtx.destination);
}

async function loadAudio(file) {
    initAudio();
    if (isPlaying) stopAudio(true);
    currentFile = file;
    const buf = await file.arrayBuffer();
    audioBuffer = await audioCtx.decodeAudioData(buf);

    const raw = audioBuffer.getChannelData(0);
    const samples = 300, blockSize = Math.floor(raw.length / samples);
    waveformData = [];
    for (let i = 0; i < samples; i++) {
        let sum = 0;
        for (let j = 0; j < blockSize; j++) sum += Math.abs(raw[i * blockSize + j]);
        waveformData.push(sum / blockSize);
    }
    const mx = Math.max(...waveformData, 0.01);
    waveformData = waveformData.map(v => v / mx);

    $('emptyState').classList.add('hidden');
    $('fileName').textContent = file.name;
    $('durationText').textContent = fmtTime(audioBuffer.duration);
    $('sysFile').textContent = file.name;
    $('sysType').textContent = file.type || 'audio';
    $('sysSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
    $('sysSR').textContent = audioBuffer.sampleRate + ' Hz';
    $('sysCh').textContent = audioBuffer.numberOfChannels >= 2 ? 'Stereo' : 'Mono';
    $('sysDur').textContent = fmtTime(audioBuffer.duration);
    $('trackInfo').textContent = (audioBuffer.sampleRate / 1000).toFixed(1) + 'k/16';

    pauseOffset = 0;
    drawWaveform(); updateTimeScale(); playAudio();
}

function playAudio() {
    if (!audioBuffer) return;
    if (isPlaying) stopAudio(true);
    sourceNode = audioCtx.createBufferSource();
    sourceNode.buffer = audioBuffer;
    sourceNode.connect(biquadFilter);
    sourceNode.onended = () => {
        if (isPlaying) {
            if (loopMode === 'single') {
                pauseOffset = 0; playAudio(); // 单曲循环
            } else {
                isPlaying = false; pauseOffset = 0; updateUI();
            }
        }
    };
    startTime = audioCtx.currentTime - pauseOffset;
    sourceNode.start(0, pauseOffset);
    isPlaying = true; updateUI(); animate();
}

function pauseAudio() {
    if (!isPlaying) return;
    pauseOffset = audioCtx.currentTime - startTime;
    sourceNode.onended = null; sourceNode.stop(); sourceNode.disconnect(); sourceNode = null;
    isPlaying = false; updateUI(); cancelAnimationFrame(animFrame);
}

function stopAudio(internal) {
    if (sourceNode) { sourceNode.onended = null; sourceNode.stop(); sourceNode.disconnect(); sourceNode = null; }
    isPlaying = false;
    if (!internal) { pauseOffset = 0; $('timer').textContent = '0.00.00'; $('meterL').style.height = '0%'; $('meterR').style.height = '0%'; drawWaveform(); }
    updateUI(); cancelAnimationFrame(animFrame);
}

function togglePlay() { if (!audioBuffer) return; if (isPlaying) pauseAudio(); else playAudio(); }

function seek(t) {
    if (!audioBuffer) return;
    t = Math.max(0, Math.min(t, audioBuffer.duration));
    pauseOffset = t;
    if (isPlaying) { stopAudio(true); playAudio(); }
    else { $('timer').textContent = fmtTime(t); drawWaveform(); }
}

function getCurTime() {
    if (!audioBuffer) return 0;
    if (!isPlaying) return pauseOffset;
    return Math.min(audioCtx.currentTime - startTime, audioBuffer.duration);
}

// ─── EQ ───
const eqPresets = {
    normal: { type: 'peaking', freq: 1000, gain: 0, q: 1 },
    bass:   { type: 'lowshelf', freq: 200, gain: 12, q: 1 },
    vocal:  { type: 'peaking', freq: 2500, gain: 8, q: 2 },
    rock:   { type: 'peaking', freq: 4000, gain: 6, q: 0.5 },
};
function applyEQ(preset) {
    if (!biquadFilter) return;
    const p = eqPresets[preset];
    biquadFilter.type = p.type; biquadFilter.frequency.value = p.freq;
    biquadFilter.gain.value = p.gain; biquadFilter.Q.value = p.q;
    document.querySelectorAll('.eq-btn').forEach(b => b.classList.toggle('active', b.dataset.eq === preset));
}

// ─── Waveform ───
function drawWaveform() {
    const canvas = $('waveformCanvas');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    const w = rect.width, h = rect.height;
    ctx.clearRect(0, 0, w, h);
    if (waveformData.length === 0) return;
    const barW = w / waveformData.length;
    const ct = getCurTime(), dur = audioBuffer ? audioBuffer.duration : 1, progress = ct / dur;
    for (let i = 0; i < waveformData.length; i++) {
        const x = i * barW, barH = waveformData[i] * (h - 4);
        ctx.fillStyle = i / waveformData.length < progress ? 'rgba(211,47,47,0.7)' : 'rgba(255,255,255,0.4)';
        ctx.fillRect(x, h - barH - 2, Math.max(barW - 1, 1), barH);
    }
    $('cursorLine').style.left = (15 + progress * rect.width) + 'px';
}

function updateTimeScale() {
    if (!audioBuffer) return;
    const el = $('timeScale'); el.innerHTML = '';
    for (let i = 0; i <= 6; i++) { const s = document.createElement('span'); s.textContent = fmtTime(audioBuffer.duration * i / 6); el.appendChild(s); }
}

// ─── Meters ───
function getLevel(analyser) {
    const d = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(d);
    let s = 0; for (let i = 0; i < d.length; i++) s += d[i]; return s / (d.length * 255);
}

// ─── Animation ───
function animate() {
    if (!isPlaying) return;
    $('timer').textContent = fmtTime(getCurTime());
    drawWaveform();
    $('meterL').style.height = (getLevel(analyserL) * 100) + '%';
    $('meterR').style.height = (getLevel(analyserR) * 100) + '%';
    animFrame = requestAnimationFrame(animate);
}

// ─── UI ───
function updateUI() {
    $('playDot').classList.toggle('active', isPlaying);
    $('playIndicator').classList.toggle('active', isPlaying);
    $('statusText').textContent = isPlaying ? 'PLAY' : (pauseOffset > 0 ? 'PAUSE' : 'STOP');
    $('jogWheel').classList.toggle('spinning', isPlaying);
    $('jogIcon').innerHTML = isPlaying
        ? '<div class="pause-icon"><div></div><div></div></div>'
        : '<div class="play-icon"></div>';
    // Update play/pause button
    $('playPauseBtn').innerHTML = isPlaying ? '&#10074;&#10074;' : '&#9654;';
}

function toggleLoopMode() {
    const modes = ['list', 'single', 'shuffle'];
    const svgIcons = {
        list: '<path d="M2 5h10l-2-2M14 5v4a2 2 0 01-2 2H4l2 2M4 11H2"/>',
        single: '<path d="M2 5h10l-2-2M14 5v4a2 2 0 01-2 2H4l2 2M4 11H2"/><text x="8" y="9" font-size="5" text-anchor="middle" fill="currentColor" stroke="none">1</text>',
        shuffle: '<path d="M2 4h2l4 4-4 4H2M14 4h-2l-1.5 1.5M14 12h-2l-4-4M10.5 10.5L12 12"/>'
    };
    const idx = modes.indexOf(loopMode);
    loopMode = modes[(idx + 1) % modes.length];
    const btn = $('loopBtn');
    btn.innerHTML = '<svg class="loop-icon" viewBox="0 0 16 16">' + svgIcons[loopMode] + '</svg>';
    btn.classList.remove('single', 'shuffle');
    if (loopMode === 'single') btn.classList.add('single');
    if (loopMode === 'shuffle') btn.classList.add('shuffle');
}

function fmtTime(s) {
    if (!s || isNaN(s)) return '0.00.00';
    return Math.floor(s / 3600) + '.' + String(Math.floor((s % 3600) / 60)).padStart(2, '0') + '.' + String(Math.floor(s % 60)).padStart(2, '0');
}

function setVolume(v) {
    volume = Math.max(0, Math.min(1, v));
    if (gainNode) gainNode.gain.value = volume;
    $('volLabel').textContent = Math.round(volume * 100) + '%';
}

// ─── Events ───
$('jogWheel').addEventListener('click', togglePlay);
$('stopBtn').addEventListener('click', () => stopAudio(false));
$('playPauseBtn').addEventListener('click', togglePlay);
$('prevBtn').addEventListener('click', () => seek(0)); // 回到开头（单文件模式）
$('nextBtn').addEventListener('click', () => { if (audioBuffer) seek(audioBuffer.duration); }); // 跳到末尾
$('loopBtn').addEventListener('click', toggleLoopMode);
$('rwBtn').addEventListener('click', () => seek(getCurTime() - 10));
$('ffBtn').addEventListener('click', () => seek(getCurTime() + 10));
$('waveformCanvas').addEventListener('click', e => {
    if (!audioBuffer) return;
    const r = e.target.getBoundingClientRect();
    seek((e.clientX - r.left) / r.width * audioBuffer.duration);
});
$('volDown').addEventListener('click', () => setVolume(volume - 0.1));
$('volUp').addEventListener('click', () => setVolume(volume + 0.1));

// Popups
$('btnBack').addEventListener('click', () => { closePopups(); });
$('btnSystem').addEventListener('click', () => {
    $('effectPopup').classList.remove('show'); $('btnEffect').classList.remove('active');
    $('systemPopup').classList.toggle('show'); $('btnSystem').classList.toggle('active');
});
$('btnEffect').addEventListener('click', () => {
    $('systemPopup').classList.remove('show'); $('btnSystem').classList.remove('active');
    $('effectPopup').classList.toggle('show'); $('btnEffect').classList.toggle('active');
});
function closePopups() {
    $('systemPopup').classList.remove('show'); $('effectPopup').classList.remove('show');
    $('btnSystem').classList.remove('active'); $('btnEffect').classList.remove('active');
}
document.addEventListener('click', e => {
    if (!e.target.closest('.popup') && !e.target.closest('#btnSystem') && !e.target.closest('#btnEffect')) closePopups();
});

// EQ
document.querySelectorAll('.eq-btn').forEach(b => b.addEventListener('click', () => applyEQ(b.dataset.eq)));

// File
$('browseBtn').addEventListener('click', () => $('fileInput').click());
$('fileInput').addEventListener('change', e => { if (e.target.files[0]) loadAudio(e.target.files[0]); });

// Drag & drop
const screen = $('screen'), overlay = $('dropOverlay');
screen.addEventListener('dragenter', e => { e.preventDefault(); overlay.classList.add('show'); });
screen.addEventListener('dragover', e => e.preventDefault());
overlay.addEventListener('dragleave', e => { if (!overlay.contains(e.relatedTarget)) overlay.classList.remove('show'); });
screen.addEventListener('drop', e => {
    e.preventDefault(); overlay.classList.remove('show');
    const f = e.dataTransfer.files[0];
    if (f && f.type.startsWith('audio')) loadAudio(f);
});

// Keyboard
document.addEventListener('keydown', e => {
    if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
    if (e.code === 'ArrowLeft') seek(getCurTime() - 5);
    if (e.code === 'ArrowRight') seek(getCurTime() + 5);
});
</script>
</body>
</html>
